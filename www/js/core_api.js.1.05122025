document.addEventListener('click', function (e) {
    const link = e.target.closest('.js-core-link[data-core-action]');
    if (!link) return;

    e.preventDefault();

    const action = link.getAttribute('data-core-action');
    if (!action) return;

    // Подсветка меню — только если клик внутри <ul>
    const ul = link.closest('ul');
    if (ul) {
        ul.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
        link.classList.add('active');
    }

    const form = document.getElementById('user-profile-form');
    let formData;

    if (action === 'save_user') {
        // ВСЕГДА берём одну форму профиля
        if (form) {
            formData = new FormData(form);
        } else {
            formData = new FormData();
        }
    } else if (action === 'form_edit_user') {
        formData = new FormData();
        const userId = link.getAttribute('data-user-id');
        if (userId) {
            formData.append('user_id', userId);
        }
    } else if (action === 'form_new_user') {
        formData = new FormData(); // нет данных
    } else {
        formData = new FormData();
    }

    formData.append('action', action);

    // Для отладки — посмотреть, что реально улетает
    console.log('FormData entries:');
    for (const [k, v] of formData.entries()) {
        console.log(k, '=>', v);
    }

    fetch('/core_api.php', {
        method: 'POST',
        body: formData
    })
        .then(r => r.json())
        .then(data => {
            if (!data || data.status !== 'ok') {
                console.error('core_api error:', data);
                alert(data && data.message ? data.message : 'Ошибка при выполнении запроса');
                return;
            }

            if (action === 'form_new_user' || action === 'form_edit_user') {
                const modalBody = document.querySelector('#fullscreenModal .modal-body');
                if (modalBody) {
                    modalBody.innerHTML = data.html;
                }
                const modalEl = document.getElementById('fullscreenModal');
                if (modalEl && window.bootstrap && bootstrap.Modal) {
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.show();
                }
            } else if (action === 'save_user') {
             // Если удалили пользователя
    if (data.deleted) {
        alert(data.message || 'Пользователь удалён');

        const hiddenDirty = document.getElementById('userListDirty');
        if (hiddenDirty) {
            hiddenDirty.value = '1';
        }

        const modalEl = document.getElementById('fullscreenModal');
        if (modalEl && window.bootstrap && bootstrap.Modal) {
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
        }

        return; // дальше не идём
    }
                alert(data.message || 'Сохранено');

                const newUserId = data.user_id || null;
                const hiddenDirty = document.getElementById('userListDirty');
                if (hiddenDirty) {
                    hiddenDirty.value = '1';
                }



                if (newUserId) {
                    // Перечитываем профиль только что сохранённого пользователя
                    const fd = new FormData();
                    fd.append('action', 'form_edit_user');
                    fd.append('user_id', newUserId);

                    fetch('/core_api.php', {
                        method: 'POST',
                        body: fd
                    })
                        .then(r => r.json())
                        .then(d2 => {
                            if (!d2 || d2.status !== 'ok') {
                                console.error('core_api error (form_edit_user after save):', d2);
                                return;
                            }
                            const modalBody = document.querySelector('#fullscreenModal .modal-body');
                            if (modalBody) {
                                modalBody.innerHTML = d2.html;
                            }
                            const modalEl = document.getElementById('fullscreenModal');
                            if (modalEl && window.bootstrap && bootstrap.Modal) {
                                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modal.show();
                            }
                        });
                }
            } else {
                const main = document.getElementById('main');
                if (main && data.html) {
                    main.innerHTML = data.html;
                }
            }
        })
        .catch(err => {
            console.error('core_api fetch error:', err);
            alert('Ошибка связи с сервером');
        });
});

document.addEventListener('DOMContentLoaded', function () {
    const modalEl = document.getElementById('fullscreenModal');
    if (!modalEl) return;

    modalEl.addEventListener('hidden.bs.modal', function () {
        const hiddenDirty = document.getElementById('userListDirty');
        if (!hiddenDirty || hiddenDirty.value !== '1') {
            return;
        }
        hiddenDirty.value = '0';

        const fd = new FormData();
        fd.append('action', 'view_users');

        fetch('/core_api.php', {
            method: 'POST',
            body: fd
        })
            .then(r => r.json())
            .then(d => {
                if (!d || d.status !== 'ok') {
                    console.error('core_api error (view_users after modal close):', d);
                    return;
                }
                const main = document.getElementById('main');
                if (main && d.html) {
                    main.innerHTML = d.html;
                }
            })
            .catch(err => {
                console.error('core_api fetch error (view_users after modal close):', err);
            });
    });
});
