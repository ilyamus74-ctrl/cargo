<section class="section">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body pt-3">
          <h5 class="card-title">Коннектор форварда</h5>
          <form id="connector-form" autocomplete="off">
            <input type="hidden" name="connector_id" value="{$connector.id|default:0}">

            <div class="row mb-3">
              <label for="connector_name" class="col-md-4 col-lg-3 col-form-label">Название</label>
              <div class="col-md-8 col-lg-9">
                <input type="text"
                       class="form-control"
                       id="connector_name"
                       name="name"
                       value="{$connector.name|escape}"
                       placeholder="Forwarder Ltd">
              </div>
            </div>

            <div class="row mb-3">
              <label for="connector_countries" class="col-md-4 col-lg-3 col-form-label">Страны</label>
              <div class="col-md-8 col-lg-9">
                <input type="text"
                       class="form-control"
                       id="connector_countries"
                       name="countries"
                       value="{$connector.countries|escape}"
                       placeholder="US, CA, MX">
                <div class="form-text">Коды стран через запятую.</div>
              </div>
            </div>

            <div class="row mb-3">
              <label for="connector_base_url" class="col-md-4 col-lg-3 col-form-label">Base URL</label>
              <div class="col-md-8 col-lg-9">
                <input type="text"
                       class="form-control"
                       id="connector_base_url"
                       name="base_url"
                       value="{$connector.base_url|escape}"
                       placeholder="https://portal.forwarder.com/api">
              </div>
            </div>

            <div class="row mb-3">
              <label for="connector_auth_type" class="col-md-4 col-lg-3 col-form-label">Тип доступа</label>
              <div class="col-md-8 col-lg-9">
                <select class="form-select" id="connector_auth_type" name="auth_type">
                  <option value="login" {if $connector.auth_type == 'login'}selected{/if}>Логин / пароль</option>
                  <option value="token" {if $connector.auth_type == 'token'}selected{/if}>API токен</option>
                </select>
              </div>
            </div>

            <div data-connector-auth="login">
              <div class="row mb-3">
                <label for="connector_username" class="col-md-4 col-lg-3 col-form-label">Логин</label>
                <div class="col-md-8 col-lg-9">
                  <input type="text"
                         class="form-control"
                         id="connector_username"
                         name="auth_username"
                         value="{$connector.auth_username|escape}"
                         placeholder="login@example.com">
                </div>
              </div>

              <div class="row mb-3">
                <label for="connector_password" class="col-md-4 col-lg-3 col-form-label">Пароль</label>
                <div class="col-md-8 col-lg-9">
                  <input type="password"
                         class="form-control"
                         id="connector_password"
                         name="auth_password"
                         value=""
                         placeholder="••••••••">
                  {if $connector.id}
                    <div class="form-text">Оставьте пустым, чтобы не менять пароль.</div>
                  {/if}
                </div>
              </div>
            </div>

            <div data-connector-auth="token">
              <div class="row mb-3">
                <label for="connector_token" class="col-md-4 col-lg-3 col-form-label">API токен</label>
                <div class="col-md-8 col-lg-9">
                  <input type="password"
                         class="form-control"
                         id="connector_token"
                         name="api_token"
                         value=""
                         placeholder="token">
                  {if $connector.id}
                    <div class="form-text">Оставьте пустым, чтобы не менять токен.</div>
                  {/if}
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <label for="connector_notes" class="col-md-4 col-lg-3 col-form-label">Комментарий</label>
              <div class="col-md-8 col-lg-9">
                <textarea class="form-control"
                          id="connector_notes"
                          name="notes"
                          rows="3">{$connector.notes|escape}</textarea>
              </div>
            </div>


            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Ручное подтверждение</label>
              <div class="col-md-8 col-lg-9">
                <div class="alert alert-light border small mb-2">
                  {$connector.manual_instruction|default:'При необходимости вручную пройдите капчу и вставьте токен/куки.'|escape}
                </div>
                <div class="alert alert-info small mb-2">
                  Для операторов без DevTools можно использовать расширение браузера:
                  откройте сайт поставщика, нажмите кнопку расширения и отправьте токен/куки в систему.
                  <a href="/extension/connector_auth_sender/README.md" target="_blank">Инструкция</a>
                </div>
                <div class="mb-2">
                  <label for="connector_auth_token" class="form-label small">Токен</label>
                  <textarea class="form-control"
                            id="connector_auth_token"
                            name="auth_token"
                            rows="2"
                            placeholder="Bearer token...">{$connector.auth_token|escape}</textarea>
                </div>
                <div class="mb-2">
                  <label for="connector_auth_token_expires" class="form-label small">Срок токена (YYYY-MM-DD HH:MM:SS)</label>
                  <input type="text"
                         class="form-control"
                         id="connector_auth_token_expires"
                         name="auth_token_expires_at"
                         value="{$connector.auth_token_expires_at|default:''|escape}">
                </div>
                <div class="mb-2">
                  <label for="connector_auth_cookies" class="form-label small">Cookies</label>
                  <textarea class="form-control"
                            id="connector_auth_cookies"
                            name="auth_cookies"
                            rows="3"
                            placeholder="cookie1=value1; cookie2=value2">{$connector.auth_cookies|escape}</textarea>
                </div>
                <div class="small text-muted">
                  ID коннектора: {$connector.id|default:'—'}<br>
                  Последнее подтверждение: {$connector.last_manual_confirm_at|default:'—'}
                </div>
                {if $connector.id}
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm mt-2 js-core-link"
                          data-core-action="manual_confirm_connector"
                          data-connector-id="{$connector.id}">
                    Обновить токен
                  </button>
                  <button type="button"
                          class="btn btn-outline-primary btn-sm mt-2 js-core-link"
                          data-core-action="manual_confirm_puppeteer"
                          data-connector-id="{$connector.id}">
                    Открыть браузер
                  </button>
                {/if}
              </div>
            </div>

            <div class="row mb-3">
              <label for="connector_scenario" class="col-md-4 col-lg-3 col-form-label">Сценарий входа</label>
              <div class="col-md-8 col-lg-9">
                <textarea class="form-control"
                          id="connector_scenario"
                          name="scenario_json"
                          rows="10"
                          placeholder="JSON сценарий входа">{$connector.scenario_json|escape}</textarea>
                <div class="form-text">
                  Укажите URL входа, параметры формы и критерий успеха (селектор/текст). Для API шагов используйте steps с expect.
                </div>
                <pre class="form-text mb-0">{literal}{"manual_confirm":{"required":true,"instruction":"Оператор проходит капчу и нажимает \"Обновить токен\""},"login":{"url":"https://portal.example.com/login","method":"POST","fields":{"username":"${login}","password":"${password}"}},"success":{"selector":"a[href*=\"logout\"]","text":"Log out"},"steps":[{"name":"Dashboard","url":"https://portal.example.com/dashboard","method":"GET","success":{"selector":".user-profile"}},{"name":"Balance API","url":"https://portal.example.com/api/balance","method":"GET","expect":{"json_path":"data.balance","operator":">","value":0}}]}{/literal}</pre>
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Активен</label>
              <div class="col-md-8 col-lg-9">
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         id="connector_is_active"
                         name="is_active"
                         value="1"
                         {if $connector.is_active == 1}checked{/if}>
                  <label class="form-check-label" for="connector_is_active">Использовать для синхронизации</label>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">SSL ignored</label>
              <div class="col-md-8 col-lg-9">
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         id="connector_ssl_ignore"
                         name="ssl_ignore"
                         value="1"
                         {if $connector.ssl_ignore == 1}checked{/if}>
                  <label class="form-check-label" for="connector_ssl_ignore">Игнорировать проверку SSL</label>
                </div>
                <div class="form-text">Используйте для самоподписных сертификатов. Опасно для продакшна.</div>
              </div>
            </div>

            <div class="row mb-3">
              <label class="col-md-4 col-lg-3 col-form-label">Состояние</label>
              <div class="col-md-8 col-lg-9">
                <div class="small text-muted">Последний обмен: {$connector.last_sync_at|default:'—'}</div>
                <div class="small text-muted">Успешное обновление: {$connector.last_success_at|default:'—'}</div>
                <div class="small text-danger">{$connector.last_error|default:''|escape}</div>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="button" class="btn btn-primary js-core-link" data-core-action="save_connector">
                Сохранить
              </button>

              {if $connector.id}
                <button type="button"
                        class="btn btn-outline-secondary js-core-link"
                        data-core-action="test_connector"
                        data-connector-id="{$connector.id}">
                  Проверить
                </button>
              {/if}

              {if $connector.id}
                <button type="button"
                        class="btn btn-outline-danger js-core-link"
                        data-core-action="save_connector"
                        data-delete="1">
                  Удалить
                </button>
              {/if}
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
