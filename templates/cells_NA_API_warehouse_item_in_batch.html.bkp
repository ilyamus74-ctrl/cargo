


<form id="item-in-modal-form" class="row g-3">
  <input type="hidden" name="batch_uid" value="{$batch_uid}">
  <input type="hidden" name="carrierCode" value="">

  <div class="col-md-4">
    <label for="tuid" class="form-label">
      TUID
      <span id="ocrCarrierInfo" class="text-muted"></span>
    </label>
    <input type="text" class="form-control" id="tuid" name="tuid" required>
  </div>

  <div class="col-md-4">
    <label for="trackingNo" class="form-label">Трек-номер</label>
    <input type="text" class="form-control" id="trackingNo" name="tracking_no" required>
  </div>

  <div class="col-md-4">
     <label for="carrierName" class="form-label">Перевозчик</label>
     <input type="text" class="form-control" id="carrierName" name="carrier_name" readonly>
     <input type="hidden" id="senderName" name="carrier_code">
  </div>

  <div class="col-md-4">
    <label class="form-label" for="receiverCountry">Страна получателя</label>
    <select class="form-select"
            id="receiverCountry"
            name="receiver_country_code">
              {foreach $dest_country as $b}
              <option value="{$b.code_iso2}">{$b.name_en}</option>
              {/foreach}
      <!-- опции будем заполнять JS-ом -->
    </select>
  </div>

  <div class="col-md-6">
    <label for="receiverName" class="form-label">Получатель</label>
    <input type="text" class="form-control" id="receiverName" name="receiver_name">
  </div>

  <div class="col-md-6">
    <label for="receiverAddress" class="form-label">Ячейка</label>
    <input type="text" class="form-control" id="receiverAddress" name="receiver_address">
  </div>


  <div class="col-md-6">
    <label class="form-label" for="receiverCompany">Компания форвард</label>
    <select class="form-select"
            id="receiverCompany"
            name="receiver_company">
             <option value="COLIBRI">COLIBRI</option>
             <option value="KOLLI">KOLLI</option>
             <option value="ASER">ASER</option>
             <option value="CAMEX">CAMEX</option>
             <option value="KARGOFLEX">KARGOFLEX</option>
             <option value="CAMARATC">CAMARATC</option>
             <option value="POSTLINK">POSTLINK</option>

              {*foreach $dest_country as $b}
     <option value="{$b.code_iso2}">{$b.name_en}</option>
              {/foreach*}
    </select>
  </div>

<!--  <div class="col-md-6">
    <label for="receiverCompany" class="form-label">Компания форвард</label>
    <input type="text" class="form-control" id="receiverCompany" name="receiver_company">
  </div>-->

  <div class="col-md-6">
    <label for="senderName" class="form-label">Форвард CODE</label>
    <input type="text" class="form-control" id="carrierCode" name="sender_code">
  </div>

  <div class="col-md-3">
    <label for="weightKg" class="form-label">Вес, кг</label>
    <input type="number" step="0.001" class="form-control" id="weightKg" name="weight_kg">
  </div>

  <div class="col-md-3">
    <label for="sizeL" class="form-label">Длина, см</label>
    <input type="number" step="0.1" class="form-control" id="sizeL" name="size_l_cm">
  </div>

  <div class="col-md-3">
    <label for="sizeW" class="form-label">Ширина, см</label>
    <input type="number" step="0.1" class="form-control" id="sizeW" name="size_w_cm">
  </div>

  <div class="col-md-3">
    <label for="sizeH" class="form-label">Высота, см</label>
    <input type="number" step="0.1" class="form-control" id="sizeH" name="size_h_cm">
  </div>

  <div class="col-12">
    <button type="button"
            class="btn btn-primary js-core-link"
            data-core-action="add_new_item_in">
      Добавить посылку
    </button>
  </div>
</form>

<hr>

<h5>Посылки в партии {$batch_uid}</h5>

<table class="table table-sm align-middle">
  <thead>
    <tr>
      <th>#</th>
      <th>Трек</th>
      <th>Получатель</th>
      <th>Вес</th>
      <th></th>
      <th>Габариты</th>
      <th>Создано</th>
    </tr>
  </thead>
  <tbody>
    {foreach $items as $p}
      <tr>
        <td>{$p.id}</td>
        <td>{$p.tracking_no|escape}</td>
        <td>{$p.receiver_name|escape}</td>
        <td>{if $p.weight_kg}{$p.weight_kg} кг{/if}</td>
        <td class="text-end">
          <button type="button"
                  class="btn btn-sm btn-outline-danger js-core-link"
                  data-core-action="delete_item_in"
                  data-item-id="{$p.id}">
            Удалить
          </button>
        </td>
        <td>
          {if $p.size_l_cm || $p.size_w_cm || $p.size_h_cm}
            {$p.size_l_cm}×{$p.size_w_cm}×{$p.size_h_cm} см
          {/if}
        </td>
        <td>{$p.created_at}</td>
      </tr>
    {/foreach}
    {if !$items}
      <tr>
        <td colspan="6" class="text-center text-muted">
          В этой партии ещё нет посылок
        </td>
      </tr>
    {/if}
  </tbody>
</table>

<div class="mt-3 text-end">
  <button type="button"
          class="btn btn-success js-core-link"
          data-core-action="commit_item_in_batch"
          data-batch-uid="{$batch_uid}">
    Завершить партию (на склад)
  </button>
</div>


<script id="device-scan-config" type="application/json">
{
  "task_id": "warehouse_in",
  "default_mode": "ocr",
  "modes": ["ocr"],
  "barcode": { "action": "fill_field", "field_id": "trackingNo" },
  "qr":      { "action": "api_check",  "endpoint": "/api/qr_check.php" }
}
</script>
<div id="ocr-templates" style="display:none">
    {$jsonOcrTemplates}
</div>
<div id="ocr-templates-destcountry" style="display:none">
    {$jsonDestCountry}
</div>

<div id="ocr-dicts" style="display:none">
    {$jsonOcrDicts}
</div>

